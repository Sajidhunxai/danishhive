// Prisma Schema for Talent Forge Platform with MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User Authentication
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  phoneNumber       String?   @unique
  phoneVerified     Boolean   @default(false)
  phoneVerifiedAt   DateTime?
  userType          UserType  @default(FREELANCER)
  isAdmin           Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  profile           Profile?
  jobs              Job[]
  jobApplications   JobApplication[]
  sentMessages      Message[]      @relation("SentMessages")
  receivedMessages  Message[]      @relation("ReceivedMessages")
  contracts         Contract[]     @relation("ClientContracts")
  freelancerContracts Contract[]   @relation("FreelancerContracts")
  forumPosts        ForumPost[]
  forumReplies      ForumReply[]
  honeyTransactions HoneyTransaction[]
  languageSkills    LanguageSkill[]
  earnings          Earning[]
  reportedProfiles  ProfileReport[]      @relation("ReporterProfiles")
  assignedTranslations AttachmentTranslation[] @relation("AssignedTranslations")
  requestedTranslations AttachmentTranslation[] @relation("RequestedTranslations")
  
  @@map("users")
}

enum UserType {
  FREELANCER
  CLIENT
  ADMIN
}

// User Profile
model Profile {
  id                    String    @id @default(uuid())
  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName              String
  companyName           String?
  cvrNumber             String?
  bio                   String?   @db.Text
  skills                Json?
  hourlyRate            Decimal?  @db.Decimal(10, 2)
  location              String?
  address               String?
  city                  String?
  postalCode            String?
  avatarUrl             String?
  birthday              DateTime?
  paymentVerified       Boolean   @default(false)
  paymentVerifiedAt     DateTime?
  mollieCustomerId      String?
  stripeCustomerId      String?
  honeyDropsBalance     Int       @default(0)
  platformFeeRate       Decimal?  @db.Decimal(5, 4)
  reducedFeeUntil       DateTime?
  mitidVerified         Boolean   @default(false)
  mitidVerifiedAt       DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  projects              Project[]
  profileImages         ProfileImage[]
  profileReports        ProfileReport[]      @relation("ReportedProfiles")
  
  @@map("profiles")
}

// Projects/Portfolio
model Project {
  id          String    @id @default(uuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  title       String
  description String?   @db.Text
  clientName  String?
  projectUrl  String?
  imageUrl    String?
  projectType String    @default("portfolio")
  startDate   DateTime?
  endDate     DateTime?
  technologies Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("projects")
}

// Jobs
model Job {
  id              String    @id @default(uuid())
  clientId        String
  client          User      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title           String
  description     String    @db.Text
  budget          Decimal?  @db.Decimal(10, 2)
  hourlyRate      Decimal?  @db.Decimal(10, 2)
  location        String?
  skills          Json?
  status          String    @default("open")
  deadline        DateTime?
  attachments     Json?
  viewCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  applications    JobApplication[]
  contracts       Contract[]
  earnings        Earning[]
  translations    AttachmentTranslation[]
  
  @@map("jobs")
}

// Job Applications
model JobApplication {
  id              String    @id @default(uuid())
  jobId           String
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  freelancerId    String
  freelancer      User      @relation(fields: [freelancerId], references: [id], onDelete: Cascade)
  coverLetter     String    @db.Text
  proposedRate    Decimal?  @db.Decimal(10, 2)
  status          String    @default("pending")
  submittedAt     DateTime  @default(now())
  reviewedAt      DateTime?
  
  @@unique([jobId, freelancerId])
  @@map("job_applications")
}

// Contracts
model Contract {
  id                      String    @id @default(uuid())
  jobId                   String
  job                     Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  clientId                String
  client                  User      @relation("ClientContracts", fields: [clientId], references: [id])
  freelancerId            String?
  freelancer              User?     @relation("FreelancerContracts", fields: [freelancerId], references: [id])
  contractNumber          String    @unique
  title                   String
  content                 String    @db.Text
  terms                   String?   @db.Text
  paymentTerms            String?   @db.Text
  deadline                DateTime?
  totalAmount             Decimal?  @db.Decimal(10, 2)
  status                  String    @default("draft")
  fileUrl                 String?
  clientSignatureDate     DateTime?
  freelancerSignatureDate DateTime?
  clientSignatureData     String?   @db.Text
  freelancerSignatureData String?   @db.Text
  metadata                Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@map("contracts")
}

// Messages
model Message {
  id           String    @id @default(uuid())
  senderId     String
  sender       User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId   String
  receiver     User      @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  content      String    @db.Text
  isRead       Boolean   @default(false)
  readAt       DateTime?
  conversationId String?
  createdAt    DateTime  @default(now())
  
  @@map("messages")
  @@index([senderId, receiverId])
  @@index([conversationId])
}

// Forum
model ForumCategory {
  id          String      @id @default(uuid())
  name        String
  description String?     @db.Text
  icon        String?
  postCount   Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  posts       ForumPost[]
  
  @@map("forum_categories")
}

model ForumPost {
  id            String        @id @default(uuid())
  categoryId    String
  category      ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  authorId      String
  author        User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  title         String
  content       String        @db.Text
  replyCount    Int           @default(0)
  lastReplyAt   DateTime      @default(now())
  lastReplyBy   String?
  isPinned      Boolean       @default(false)
  isLocked      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  replies       ForumReply[]
  
  @@map("forum_posts")
}

model ForumReply {
  id            String      @id @default(uuid())
  postId        String
  post          ForumPost   @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId      String
  author        User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content       String      @db.Text
  parentReplyId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("forum_replies")
}

// Honey Drops (Virtual Currency)
model HoneyTransaction {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int
  type        String    // purchase, spend, refund
  description String?
  paymentId   String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  
  @@map("honey_transactions")
}

// Phone Verification
model PhoneVerification {
  id               String    @id @default(uuid())
  phoneNumber      String    @unique
  verificationCode String
  expiresAt        DateTime
  createdAt        DateTime  @default(now())
  
  @@map("phone_verifications")
}

// Referrals
model Referral {
  id               String   @id @default(uuid())
  referrerId       String
  referredEmail    String
  status           String   @default("pending")
  referredEarnings Int      @default(0)
  bonusPaid        Boolean  @default(false)
  bonusPaidAt      DateTime?
  createdAt        DateTime @default(now())

  @@unique([referrerId, referredEmail])
  @@map("referrals")
}

model ReferralBonus {
  id         String   @id @default(uuid())
  referrerId String
  amount     Int
  status     String   @default("pending") // pending | completed | cancelled
  createdAt  DateTime @default(now())

  @@map("referral_bonuses")
}

// Email Change Requests
model EmailChangeRequest {
  id                String    @id @default(uuid())
  userId            String
  newEmail          String
  verificationToken String    @unique
  expiresAt         DateTime
  status            String    @default("pending")
  createdAt         DateTime  @default(now())
  
  @@map("email_change_requests")
}

// Coupons
model Coupon {
  id          String    @id @default(uuid())
  code        String    @unique
  discount    Decimal   @db.Decimal(5, 2)
  maxUses     Int?
  usedCount   Int       @default(0)
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  @@map("coupons")
}

// Language Skills
model LanguageSkill {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  languageCode     String
  languageName     String
  proficiencyLevel String    @default("beginner")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@map("language_skills")
  @@index([userId])
}

// Earnings
model Earning {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId             String?
  job               Job?      @relation(fields: [jobId], references: [id], onDelete: SetNull)
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    @default("DKK")
  paymentPeriodStart DateTime
  paymentPeriodEnd   DateTime
  payoutDate        DateTime?
  status            String    @default("pending") // pending | processing | paid | cancelled
  molliePaymentId   String?
  description       String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("earnings")
  @@index([userId])
  @@index([jobId])
}

// Profile Images for Approval
model ProfileImage {
  id          String    @id @default(uuid())
  userId      String
  profile     Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  imageType   String    // portrait, company_logo
  status      String    @default("pending") // pending, approved, rejected
  adminNotes  String?   @db.Text
  approvedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("profile_images")
  @@index([status])
  @@index([userId])
}

// Profile Reports
model ProfileReport {
  id              String    @id @default(uuid())
  reporterId      String
  reporter        User      @relation("ReporterProfiles", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUserId  String
  reportedProfile Profile   @relation("ReportedProfiles", fields: [reportedUserId], references: [id], onDelete: Cascade)
  reportCategory  String
  reportReason    String    @db.Text
  description     String?   @db.Text
  conversationData Json?
  status          String    @default("pending") // pending, reviewed, resolved, dismissed
  adminNotes      String?   @db.Text
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("profile_reports")
  @@index([status])
  @@index([reportedUserId])
}

// Attachment Translations
model AttachmentTranslation {
  id              String    @id @default(uuid())
  jobId           String
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  attachmentId   String    // fileId from job attachments JSON
  originalLanguage String
  targetLanguage  String
  notes           String?   @db.Text
  status          String    @default("pending") // pending, assigned, in_progress, completed, cancelled
  assignedTo      String?   // User ID of team leader/translator
  assignedUser    User?     @relation("AssignedTranslations", fields: [assignedTo], references: [id], onDelete: SetNull)
  requestedBy     String?   // User ID who requested the translation
  requester       User?     @relation("RequestedTranslations", fields: [requestedBy], references: [id], onDelete: SetNull)
  translatedFileUrl String? // URL to translated file when completed
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("attachment_translations")
  @@index([status])
  @@index([jobId])
  @@index([assignedTo])
  @@index([requestedBy])
}

// Under-18 Applications
model Under18Application {
  id                  String    @id @default(uuid())
  email               String
  birthday            DateTime
  languageSkills      Json?     // Array of language skills
  softwareSkills      Json?     // Array of software skills
  codeLanguages       Json?     // Array of programming languages
  educationInstitution String?
  cvFilePath          String
  cvFileName          String
  status              String    @default("pending") // pending, reviewed, approved, rejected
  adminNotes          String?   @db.Text
  reviewedBy          String?
  reviewedAt          DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@map("under18_applications")
  @@index([status])
  @@index([email])
}

// Universities
model University {
  id          String    @id @default(uuid())
  name        String
  city        String
  type        String    // University, Business School, etc.
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("universities")
  @@index([city])
  @@index([type])
}

